name: Weekly Download Test

# on:
#   schedule:
#     # Run every Sunday at 02:00 UTC
#     - cron: '0 2 * * 0'
#   workflow_dispatch: # Allow manual triggering
on: [push]

jobs:
  download-install-test:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]

    steps:
    # - name: Set up curl on macOS
    #   if: runner.os == 'macOS'
    #   run: |
    #     echo "Setting up curl-openssl on macOS"
    #     brew upgrade
    #     brew uninstall curl
    #     brew install curl-openssl
    #     echo 'export PATH="/opt/homebrew/opt/curl/bin:$PATH"' >> /Users/runner/.bash_profile
    - name: Test viash download and installation
      run: |
        set +e

        echo "testing curl to ip address"

        curl -vi http://217.19.237.54

        echo "testing curl to dl.viash.io"

        curl -fLvi https://dl.viash.io > /dev/null

        echo "testing curl to google.com"

        curl -vi http://google.com

        echo "testing curl to viash.io"

        curl -vi https://viash.io

        echo "testing curl to viash-hub.com"

        curl -vi https://viash-hub.com

        echo "testing curl to www.viash-hub.com"

        curl -vi https://www.viash-hub.com

        set -e

        echo "Testing viash download from https://dl.viash.io"

        # Download viash
        curl -fsSL https://dl.viash.io | bash
        
        # Verify installation
        if [ -f "./viash" ]; then
          echo "âœ… viash binary exists locally"
          ./viash --version
          echo "âœ… viash version check successful"
        else
          echo "âŒ viash binary not found in local directory after installation"
          exit 1
        fi
        
        # Test basic functionality
        echo "Testing basic viash functionality..."
        ./viash --help > /dev/null
        echo "âœ… viash help command works"

    - name: Notify download test failure
      if: failure()
      run: |
        curl -X POST \
          -H 'Content-Type: application/json' \
          -d '{
            "text": "ðŸš¨ *Viash Download Test Failed*\n\nâ€¢ **OS**: ${{ matrix.os }}\nâ€¢ **Issue**: Failed to download/install viash from https://dl.viash.io\nâ€¢ **Repository**: ${{ github.repository }}\nâ€¢ **Run**: <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Logs>"
          }' \
          "${{ secrets.GOOGLE_CHAT_WEBHOOK_URL }}"
